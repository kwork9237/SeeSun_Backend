<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.seesun.mapper.member.MemberMapper">
	<!-- 로그인 시 사용 (Username 으로 회원 특정 데이터) -->
	<select id="getAuthenticationByUsername" resultType="authentication">
		SELECT
			mb_id AS mbId,
			username,
			password,
			mb_type_id AS mbTypeId
		FROM member
		WHERE username = #{username}
	</select>
	
	<!-- 회원가입 -->
	<insert id="insertMember" parameterType="memberJoin" useGeneratedKeys="true" keyProperty="mbId">
		INSERT INTO member (
			username,
			password,
			name,
			nickname,
			phone
		)
		VALUES (
			#{username},
			#{password},
			#{name},
			#{nickname},
			#{phone}
		)
	</insert>
	
	<!-- 중복체크 -->
	<!-- front에서 value, field 정의해서 보내줘야 한다. -->
	<select id="checkDuplicate" resultType="int">
		SELECT EXISTS (
			SELECT 1
			FROM member
			WHERE
			<choose>
				<when test="field == 'username'">
					username = #{value}
				</when>
				<when test="field == 'nickname'">
					nickname = #{value}
				</when>
				<when test="field == 'phone'">
					phone = #{value}
				</when>
				<otherwise>
					1 = 0
				</otherwise> 
			</choose>
		)
	</select>
	
	<!-- 회원탈퇴 -->
	<delete id="deleteMemberByMbId">
		DELETE FROM member WHERE mb_id = #{mb_id}
	</delete>
	
	<!-- 회원정보 수정 -->
	<update id="updateMemberInfoByMbId">
		UPDATE member
			<set>
				<if test="dto.name != null">
					name = #{dto.name},
				</if>
				<if test="dto.nickname != null">
					nickname = #{dto.nickname},
				</if>
				<if test="dto.phone != null">
					phone = #{dto.phone},
				</if>
			</set>
		WHERE mb_id = #{mb_id}
	</update>
	
	<!-- 비밀번호 수정 -->
	<update id="updatePasswordByMbId">
		UPDATE member
		SET password = #{password}
		WHERE mb_id = #{mb_id}
	</update>
	
	<!-- 비밀번호 조회 -->
	<!-- 회원탈퇴, 정보 수정 등에 이용됨. -->
	<select id="getPasswordByMbId">
		SELECT password
		FROM member
		WHERE mb_id = #{mb_id}		
	</select>
	
	<!-- 관리자 확인 -->
	<select id="checkAdmin" resultType="int">
		SELECT EXISTS (
			SELECT 1
			FROM member
			WHERE
				mb_id = #{mb_id} AND
				mb_type_id = 0
		)
	</select>
</mapper>