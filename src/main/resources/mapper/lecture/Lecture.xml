<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.seesun.mapper.lecture.LectureMapper">

    <resultMap id="LectureResultMap" type="com.seesun.dto.lecture.LectureDTO">
        <id property="leId" column="le_id" />
        <result property="title" column="title" />
        <result property="content" column="content" />
        <result property="cost" column="cost" />
        <result property="avgScore" column="avg_score" />
        <result property="difficulty" column="difficulty" />
        <result property="viewCount" column="view_count" />
        <result property="isActive" column="is_active" />
        <result property="mbId" column="mb_id" />
        <result property="instructorName" column="instructor_name" />
        <result property="profileIcon" column="profile_icon" />
        <result property="categoryName" column="category_name" />
        <result property="studentCount" column="student_count" />
        <result property="reviewCount" column="review_count" />
        
        <result property="totalHours" column="total_hours" />
        <result property="availableTime" column="available_time" />
        
        <result property="startDate" column="start_date" />
        <result property="endDate" column="end_date" />
        <result property="availableDays" column="available_days" />
    </resultMap>

    <select id="getLectureList" resultMap="LectureResultMap">
        SELECT 
            l.le_id, l.title, l.content, l.cost, l.difficulty, l.view_count, l.is_active,
            
            /* ✅ [수정] 고정된 컬럼 대신 lecture_evaluation 테이블에서 실시간 평균 계산 */
            (SELECT IFNULL(AVG(score), 0) FROM lecture_evaluation WHERE le_id = l.le_id) AS avg_score,

            m.mb_id, m.name AS instructor_name, m.profile_icon,
            c.name AS category_name,
            (SELECT COUNT(*) FROM member_enrollment e WHERE e.le_id = l.le_id) AS student_count,
            
            /* ✅ [수정] 리뷰 개수도 evaluation 테이블 기준으로 변경 (기존 view_count는 조회수임) */
            (SELECT COUNT(*) FROM lecture_evaluation WHERE le_id = l.le_id) AS review_count,
            
            /* 총 시간(시간 단위 변환) */
            (SELECT ROUND(IFNULL(SUM(ll.duration), 0) / 60, 1) 
             FROM lecture_section ls 
             JOIN lecture_lesson ll ON ls.section_id = ll.section_id 
             WHERE ls.le_id = l.le_id) AS total_hours,
            
            /* 주요 시간 포맷팅 */
            (SELECT CONCAT(DATE_FORMAT(start_time, '%H:%i'), ' ~ ', DATE_FORMAT(end_time, '%H:%i'))
             FROM lecture_schedule WHERE le_id = l.le_id LIMIT 1) AS available_time,
            
            /* 강의 시작일 */
            (SELECT MIN(schedule_date) FROM lecture_schedule WHERE le_id = l.le_id) AS start_date,
            
            /* 강의 종료일 */
            (SELECT MAX(schedule_date) FROM lecture_schedule WHERE le_id = l.le_id) AS end_date,
            
            /* 요일 정보 */
            (SELECT GROUP_CONCAT(DISTINCT (DAYOFWEEK(schedule_date) - 1) ORDER BY DAYOFWEEK(schedule_date) SEPARATOR ',')
             FROM lecture_schedule WHERE le_id = l.le_id) AS available_days
             
        FROM lecture l
        LEFT JOIN member m ON l.mb_id = m.mb_id
        LEFT JOIN language_category c ON l.lg_type_Id = c.lg_type_id
        WHERE l.is_active = 1
        
        <if test="language != null and language != '' and language != '언어'"> AND c.name = #{language} </if>
        <if test="difficulty != null"> AND l.difficulty = #{difficulty} </if>
        <if test="search != null and search != ''"> 
            AND (l.title LIKE CONCAT('%', #{search}, '%') OR l.content LIKE CONCAT('%', #{search}, '%')) 
        </if>
        
        <choose>
            <when test="sortBy == 'rating'"> ORDER BY avg_score DESC </when>
            <when test="sortBy == 'price'"> ORDER BY l.cost ASC </when>
            <otherwise> ORDER BY l.created_at DESC </otherwise>
        </choose>
    </select>

    <select id="getLectureDetail" resultMap="LectureResultMap">
        SELECT
            l.le_id, l.title, l.content, l.cost, l.difficulty, l.view_count, l.is_active,

            /* ✅ 상세 페이지 실시간 평점 계산 */
            (SELECT IFNULL(AVG(score), 0) FROM lecture_evaluation WHERE le_id = l.le_id) AS avg_score,

            m.mb_id, m.name AS instructor_name, m.profile_icon,
            c.name AS category_name,

            /* [인원 제한 로직용 데이터 추가] */
            /* 기존 student_count는 유지하면서, 결제 완료 기준의 진짜 인원수와 정원을 추가합니다. */
            (SELECT COUNT(*) FROM orders o WHERE o.le_id = l.le_id AND o.status = 2) AS currentStudents,
            IFNULL((SELECT MAX(max_students) FROM lecture_schedule WHERE le_id = l.le_id), 0) AS maxStudents,
            /* ----------------------------------------------------------- */

            (SELECT COUNT(*) FROM member_enrollment e WHERE e.le_id = l.le_id) AS student_count,

            /* ✅ 리뷰 개수 */
            (SELECT COUNT(*) FROM lecture_evaluation WHERE le_id = l.le_id) AS review_count,

            /* 총 시간 */
            (SELECT ROUND(IFNULL(SUM(ll.duration), 0) / 60, 1)
             FROM lecture_section ls JOIN lecture_lesson ll ON ls.section_id = ll.section_id
             WHERE ls.le_id = l.le_id) AS total_hours,

            /* 모든 시간대 추출 */
            (SELECT GROUP_CONCAT(DISTINCT DATE_FORMAT(start_time, '%H:%i') ORDER BY start_time SEPARATOR ',')
             FROM lecture_schedule WHERE le_id = l.le_id) AS available_time,

            (SELECT MIN(schedule_date) FROM lecture_schedule WHERE le_id = l.le_id) AS start_date,
            (SELECT MAX(schedule_date) FROM lecture_schedule WHERE le_id = l.le_id) AS end_date,
            (SELECT GROUP_CONCAT(DISTINCT (DAYOFWEEK(schedule_date) - 1) ORDER BY DAYOFWEEK(schedule_date) SEPARATOR ',')
             FROM lecture_schedule WHERE le_id = l.le_id) AS available_days

        FROM lecture l
                 LEFT JOIN member m ON l.mb_id = m.mb_id
                 LEFT JOIN language_category c ON l.lg_type_Id = c.lg_type_id
        WHERE l.le_id = #{id}
    </select>

    <insert id="insertLecture" useGeneratedKeys="true" keyProperty="dto.leId" keyColumn="le_id">
        INSERT INTO lecture (mb_id, title, content, lg_type_Id, cost, difficulty, is_active)
        VALUES (#{dto.mbId}, #{dto.title}, #{dto.description}, #{lgTypeId}, #{dto.price}, #{dto.level}, 1)
    </insert>
    
    <insert id="insertSection" useGeneratedKeys="true" keyProperty="section.sectionId" keyColumn="section_id">
        INSERT INTO lecture_section (le_id, title, order_num) 
        VALUES (#{leId}, #{section.title}, #{orderNum})
    </insert>
    
    <insert id="insertLesson">
        INSERT INTO lecture_lesson (section_id, title, duration, order_num) 
        VALUES (#{sectionId}, #{title}, #{duration}, #{orderNum})
    </insert>
    
    <insert id="insertSchedule">
        INSERT INTO lecture_schedule (le_id, schedule_date, start_time, end_time, max_students, current_students, is_available)
        VALUES (#{leId}, #{scheduleDate}, #{startTime}, #{endTime}, #{maxStudents}, 0, 1)
    </insert>

    <select id="getSectionsByLectureId" resultType="section">
        SELECT 
            section_id AS sectionId,
            title,
            order_num AS orderNum
        FROM lecture_section
        WHERE le_id = #{leId}
        ORDER BY order_num ASC
    </select>

    <select id="getLessonsBySectionId" resultType="lesson">
        SELECT 
            lesson_id AS lessonId,
            title,
            duration,
            order_num AS orderNum
        FROM lecture_lesson
        WHERE section_id = #{sectionId}
        ORDER BY order_num ASC
    </select>
</mapper>